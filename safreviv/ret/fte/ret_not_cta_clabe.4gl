#-------------------------------------------------------------------------------
# File: ret_not_cta_clabe.4gl
# GENERATED BY fglwsdl 141859
#-------------------------------------------------------------------------------
# THIS FILE WAS GENERATED. DO NOT MODIFY.
#-------------------------------------------------------------------------------


IMPORT FGL WSHelper
IMPORT com
IMPORT xml


GLOBALS "ret_not_cta_clabe.inc"



#-------------------------------------------------------------------------------
# Service: CuentaCLABE
# Port:    CuentaCLABEPort
# Server:  http://192.168.1.4:7101/CuentaCLABE/ProxyServices/CuentaCLABE
#-------------------------------------------------------------------------------

PRIVATE DEFINE notificacionCuentaClabeHTTPReq     com.HTTPRequest
PRIVATE DEFINE notificacionCuentaClabeHTTPResp    com.HTTPResponse

#-------------------------------------------------------------------------------

#
# Operation: notificacionCuentaClabe
#
#
# FUNCTION: notificacionCuentaClabe_g
#   RETURNING: soapStatus
#   INPUT: GLOBAL ns1notificacionCuentaClabeRequest
#   OUTPUT: GLOBAL ns1notificacionCuentaClabeResponse
#
FUNCTION notificacionCuentaClabe_g()
  DEFINE wsstatus   INTEGER
  DEFINE retryAuth  INTEGER
  DEFINE retryProxy INTEGER
  DEFINE retry      INTEGER
  DEFINE nb         INTEGER
  DEFINE uri        STRING
  DEFINE setcookie  STRING
  DEFINE mustUnderstand INTEGER
  DEFINE request    com.HTTPRequest
  DEFINE response   com.HTTPResponse
  DEFINE writer     xml.StaxWriter
  DEFINE reader     xml.StaxReader

  #
  # INIT VARIABLES
  #
  LET wsstatus = -1
  LET retryAuth = FALSE
  LET retryProxy = FALSE
  LET retry = TRUE
  LET uri = com.WebServiceEngine.GetOption("SoapModuleURI")

  IF CuentaCLABE_CuentaCLABEPortEndpoint.Address.Uri IS NULL THEN
    --LET CuentaCLABE_CuentaCLABEPortEndpoint.Address.Uri = "http://192.168.1.4:7101/CuentaCLABE/ProxyServices/CuentaCLABE"
    LET CuentaCLABE_CuentaCLABEPortEndpoint.Address.Uri = "alias://noticuentaclabe"
  END IF

  #
  # CREATE REQUEST
  #
  TRY
    LET request = com.HTTPRequest.Create(CuentaCLABE_CuentaCLABEPortEndpoint.Address.Uri)
    CALL request.setMethod("POST")
    #CALL request.setCharset("UTF-8")
    CALL request.setCharset("ISO-8859-1")
    CALL request.setHeader("SOAPAction","\"http://www.procesar.com.mx/CuentaCLABE/notificacionCuentaClabe\"")
    CALL WSHelper_SetRequestHeaders(request, CuentaCLABE_CuentaCLABEPortEndpoint.Binding.Request.Headers)
    IF CuentaCLABE_CuentaCLABEPortEndpoint.Binding.Version IS NOT NULL THEN
      CALL request.setVersion(CuentaCLABE_CuentaCLABEPortEndpoint.Binding.Version)
    END IF
    IF CuentaCLABE_CuentaCLABEPortEndpoint.Binding.Cookie IS NOT NULL THEN
      CALL request.setHeader("Cookie",CuentaCLABE_CuentaCLABEPortEndpoint.Binding.Cookie)
    END IF
    IF CuentaCLABE_CuentaCLABEPortEndpoint.Binding.ConnectionTimeout <> 0 THEN
      CALL request.setConnectionTimeout(CuentaCLABE_CuentaCLABEPortEndpoint.Binding.ConnectionTimeout)
    END IF
    IF CuentaCLABE_CuentaCLABEPortEndpoint.Binding.ReadWriteTimeout <> 0 THEN
      CALL request.setTimeout(CuentaCLABE_CuentaCLABEPortEndpoint.Binding.ReadWriteTimeout)
    END IF
    IF CuentaCLABE_CuentaCLABEPortEndpoint.Binding.CompressRequest IS NOT NULL THEN
      CALL request.setHeader("Content-Encoding",CuentaCLABE_CuentaCLABEPortEndpoint.Binding.CompressRequest)
    END IF
    CALL request.setHeader("Accept-Encoding","gzip, deflate")
  CATCH
    LET wsstatus = STATUS
    CALL WSHelper_FillSOAP11WSError("Client","Cannot create HTTPRequest")
    RETURN wsstatus
  END TRY

  # START LOOP
  WHILE retry
    LET retry = FALSE

    #
    # Stax request
    #
    TRY
      LET writer = request.beginXmlRequest()
      CALL WSHelper_WriteStaxSOAP11StartEnvelope(writer)
      CALL WSHelper_WriteStaxSOAP11StartBody(writer)
      #
      # STAX SOAP REQUEST SERIALIZE
      #
      CALL xml.Serializer.VariableToStax(ns1notificacionCuentaClabeRequest,writer)
      CALL WSHelper_WriteStaxSOAP11EndBody(writer)
      CALL WSHelper_WriteStaxSOAP11EndEnvelope(writer)
      CALL request.endXmlRequest(writer)
    CATCH
      LET wsstatus = STATUS
      CALL WSHelper_FillSOAP11WSError("Client",SQLCA.SQLERRM)
      RETURN wsstatus
    END TRY

    #
    # PROCESS RESPONSE
    #
    TRY
      LET response = request.getResponse()

      #
      # RETRIEVE SERVICE SESSION COOKIE
      #
 --#     LET setcookie = response.getHeader("Set-Cookie")
 --#     IF setcookie IS NOT NULL THEN
 --#       LET CuentaCLABE_CuentaCLABEPortEndpoint.Binding.Cookie = WSHelper_ExtractServerCookie(setcookie,CuentaCLABE_CuentaCLABEPortEndpoint.Address.Uri)
 --#     END IF

      #
      # RETRIEVE HTTP RESPONSE Headers
      #
 --#     CALL WSHelper_SetResponseHeaders(response, CuentaCLABE_CuentaCLABEPortEndpoint.Binding.Response.Headers)
      DISPLAY "Response getSttatuscode >",response.getStatusCode(),"<"
      CASE response.getStatusCode()

        WHEN 500 # SOAP Fault
          #
          # STAX SOAP FAULT
          #
          LET reader = response.beginXmlResponse() # Begin Streaming Response
          IF NOT WSHelper_ReadStaxSOAP11StartEnvelope(reader) THEN
            EXIT CASE
          END IF
          # Process SOAP headers 
          IF WSHelper_CheckStaxSOAP11Header(reader) THEN
            CALL reader.nextSibling() # Skip header, not necessary
          END IF 
          IF NOT WSHelper_ReadStaxSOAP11StartBody(reader) THEN
            EXIT CASE
          END IF
          IF NOT WSHelper_ReadStaxSOAP11Fault(reader) THEN
            EXIT CASE
          END IF
          IF NOT WSHelper_ReadStaxSOAP11EndBody(reader) THEN
            EXIT CASE
          END IF
          IF NOT WSHelper_ReadStaxSOAP11EndEnvelope(reader) THEN
            EXIT CASE
          END IF
          IF NOT WSHelper_ReadStaxSOAP11FaultUntilDetail(reader) THEN
            EXIT CASE
          END IF
          # End Streaming Response
          CALL response.endXmlResponse(reader)

        WHEN 200 # SOAP Result
          #
          # STAX SOAP RESPONSE
          #
          LET reader = response.beginXmlResponse() # Begin Streaming Response
          IF NOT WSHelper_ReadStaxSOAP11StartEnvelope(reader) THEN
            EXIT CASE
          END IF
          # Process SOAP headers 
          IF WSHelper_CheckStaxSOAP11Header(reader) THEN
             IF NOT reader.isEmptyElement() THEN 
                CALL WSHelper_FillSOAP11WSError("Client","No SOAP Header expected")
                EXIT CASE
             ELSE
                CALL reader.nextTag()
             END IF
          END IF 
          IF NOT WSHelper_ReadStaxSOAP11StartBody(reader) THEN
            EXIT CASE
          END IF
          # Retrieve SOAP Message taking soap:root attribute into account
          IF NOT WSHelper_RetrieveStaxSOAP11Message(reader) THEN
            EXIT CASE
          END IF
          
          CALL xml.Serializer.StaxToVariable(reader,ns1notificacionCuentaClabeResponse)
          IF NOT WSHelper_ReadStaxSOAP11EndBody(reader) THEN
            EXIT CASE
          END IF
          IF NOT WSHelper_ReadStaxSOAP11EndEnvelope(reader) THEN
            EXIT CASE
          END IF
          # End Streaming Response
          CALL response.endXmlResponse(reader)
          LET wsstatus = 0

        WHEN 401 # HTTP Authentication
          IF retryAuth THEN
            CALL WSHelper_FillSOAP11WSError("Server","HTTP Error 401 ("||response.getStatusDescription()||")")
          ELSE
            LET retryAuth = TRUE
            LET retry = TRUE
          END IF

        WHEN 407 # Proxy Authentication
          IF retryProxy THEN
            CALL WSHelper_FillSOAP11WSError("Server","HTTP Error 407 ("||response.getStatusDescription()||")")
          ELSE
            LET retryProxy = TRUE
            LET retry = TRUE
          END IF

        OTHERWISE
          CALL WSHelper_FillSOAP11WSError("Server","HTTP Error "||response.getStatusCode()||" ("||response.getStatusDescription()||")")

      END CASE
    CATCH
      LET wsstatus = status
      CALL WSHelper_FillSOAP11WSError("Server",SQLCA.SQLERRM)
      RETURN wsstatus
    END TRY

  # END LOOP
  END WHILE

  RETURN wsstatus

END FUNCTION


FUNCTION notificacionCuentaClabeRequest_g()
  DEFINE wsstatus   INTEGER
  DEFINE writer     xml.StaxWriter

  #
  # CHECK PREVIOUS CALL  
  #
  IF notificacionCuentaClabeHTTPReq IS NOT NULL AND notificacionCuentaClabeHTTPResp IS NULL THEN
    # Request was sent but there was no response yet
    CALL WSHelper_FillSOAP11WSError("Client","Cannot issue a new request until previous response was received")
    RETURN -2 # waiting for the response
  ELSE
    IF CuentaCLABE_CuentaCLABEPortEndpoint.Address.Uri IS NULL THEN
      --LET CuentaCLABE_CuentaCLABEPortEndpoint.Address.Uri = "http://192.168.1.4:7101/CuentaCLABE/ProxyServices/CuentaCLABE"
      LET CuentaCLABE_CuentaCLABEPortEndpoint.Address.Uri = "alias://noticuentaclabe"
    END IF
  END IF

  #
  # CREATE REQUEST
  #
  TRY
    LET notificacionCuentaClabeHTTPReq = com.HTTPRequest.Create(CuentaCLABE_CuentaCLABEPortEndpoint.Address.Uri)
    CALL notificacionCuentaClabeHTTPReq.setMethod("POST")
    #CALL notificacionCuentaClabeHTTPReq.setCharset("UTF-8")
    CALL notificacionCuentaClabeHTTPReq.setCharset("ISO-8859-1")
    CALL notificacionCuentaClabeHTTPReq.setHeader("SOAPAction","\"http://www.procesar.com.mx/CuentaCLABE/notificacionCuentaClabe\"")
    CALL WSHelper_SetRequestHeaders(notificacionCuentaClabeHTTPReq, CuentaCLABE_CuentaCLABEPortEndpoint.Binding.Request.Headers)
    IF CuentaCLABE_CuentaCLABEPortEndpoint.Binding.Version IS NOT NULL THEN
      CALL notificacionCuentaClabeHTTPReq.setVersion(CuentaCLABE_CuentaCLABEPortEndpoint.Binding.Version)
    END IF
    IF CuentaCLABE_CuentaCLABEPortEndpoint.Binding.Cookie IS NOT NULL THEN
      CALL notificacionCuentaClabeHTTPReq.setHeader("Cookie",CuentaCLABE_CuentaCLABEPortEndpoint.Binding.Cookie)
    END IF
    IF CuentaCLABE_CuentaCLABEPortEndpoint.Binding.ConnectionTimeout <> 0 THEN
      CALL notificacionCuentaClabeHTTPReq.setConnectionTimeout(CuentaCLABE_CuentaCLABEPortEndpoint.Binding.ConnectionTimeout)
    END IF
    IF CuentaCLABE_CuentaCLABEPortEndpoint.Binding.ReadWriteTimeout <> 0 THEN
      CALL notificacionCuentaClabeHTTPReq.setTimeout(CuentaCLABE_CuentaCLABEPortEndpoint.Binding.ReadWriteTimeout)
    END IF
    IF CuentaCLABE_CuentaCLABEPortEndpoint.Binding.CompressRequest IS NOT NULL THEN
      CALL notificacionCuentaClabeHTTPReq.setHeader("Content-Encoding",CuentaCLABE_CuentaCLABEPortEndpoint.Binding.CompressRequest)
    END IF
    CALL notificacionCuentaClabeHTTPReq.setHeader("Accept-Encoding","gzip, deflate")
  CATCH
    LET wsstatus = STATUS
    CALL WSHelper_FillSOAP11WSError("Client","Cannot create HTTPRequest")
    LET notificacionCuentaClabeHTTPReq = NULL
    RETURN wsstatus
  END TRY

    #
    # Stax request
    #
    TRY
      LET writer = notificacionCuentaClabeHTTPReq.beginXmlRequest()
      CALL WSHelper_WriteStaxSOAP11StartEnvelope(writer)
      CALL WSHelper_WriteStaxSOAP11StartBody(writer)
      #
      # STAX SOAP REQUEST SERIALIZE
      #
      CALL xml.Serializer.VariableToStax(ns1notificacionCuentaClabeRequest,writer)
      CALL WSHelper_WriteStaxSOAP11EndBody(writer)
      CALL WSHelper_WriteStaxSOAP11EndEnvelope(writer)
      CALL notificacionCuentaClabeHTTPReq.endXmlRequest(writer)
    CATCH
      LET wsstatus = STATUS
      CALL WSHelper_FillSOAP11WSError("Client",SQLCA.SQLERRM)
      LET notificacionCuentaClabeHTTPReq = NULL
      RETURN wsstatus
    END TRY

  #
  # PROCESS RESPONSE
  #
  TRY
    LET notificacionCuentaClabeHTTPResp = notificacionCuentaClabeHTTPReq.getAsyncResponse()
    RETURN 0 # SUCCESS
  CATCH
    LET wsstatus = STATUS
    CALL WSHelper_FillSOAP11WSError("Server",SQLCA.SQLERRM)
    LET notificacionCuentaClabeHTTPReq = NULL
    RETURN wsstatus
  END TRY
END FUNCTION


FUNCTION notificacionCuentaClabeResponse_g()
  DEFINE wsstatus        INTEGER
  DEFINE nb              INTEGER
  DEFINE uri             STRING
  DEFINE setcookie       STRING
  DEFINE mustUnderstand  INTEGER
  DEFINE reader          xml.StaxReader

  LET wsstatus = -1
  #
  # CHECK PREVIOUS CALL  
  #
  IF notificacionCuentaClabeHTTPReq IS NULL THEN
    # No request was sent
    CALL WSHelper_FillSOAP11WSError("Client","No request has been sent")
    RETURN -1
  END IF

  TRY
    #
    # PROCESS RESPONSE
    #
    IF notificacionCuentaClabeHTTPResp IS NULL THEN
      # Still no response, try again
      LET notificacionCuentaClabeHTTPResp = notificacionCuentaClabeHTTPReq.getAsyncResponse()
    END IF

    IF notificacionCuentaClabeHTTPResp IS NULL THEN
      # We got no response, still waiting for
      CALL WSHelper_FillSOAP11WSError("Client","Response was not yet received")
      RETURN -2
    END IF

      #
      # RETRIEVE HTTP RESPONSE Headers
      #
      CASE notificacionCuentaClabeHTTPResp.getStatusCode()

        WHEN 500 # SOAP Fault
          #
          # STAX SOAP FAULT
          #
          LET reader = notificacionCuentaClabeHTTPResp.beginXmlResponse() # Begin Streaming Response
          IF NOT WSHelper_ReadStaxSOAP11StartEnvelope(reader) THEN
            EXIT CASE
          END IF
          IF WSHelper_CheckStaxSOAP11Header(reader) THEN
              CALL reader.nextSibling() # Skip SOAP headers
          END IF
          IF NOT WSHelper_ReadStaxSOAP11StartBody(reader) THEN
            EXIT CASE
          END IF
          IF NOT WSHelper_ReadStaxSOAP11Fault(reader) THEN
            EXIT CASE
          END IF
          IF NOT WSHelper_ReadStaxSOAP11EndBody(reader) THEN
            EXIT CASE
          END IF
          IF NOT WSHelper_ReadStaxSOAP11EndEnvelope(reader) THEN
            EXIT CASE
          END IF
          # End Streaming Response
          CALL notificacionCuentaClabeHTTPResp.endXmlResponse(reader)

        WHEN 200 # SOAP Result
          #
          # STAX SOAP RESPONSE
          #
          LET reader = notificacionCuentaClabeHTTPResp.beginXmlResponse() # Begin Streaming Response
          IF NOT WSHelper_ReadStaxSOAP11StartEnvelope(reader) THEN
            EXIT CASE
          END IF
          # Process SOAP headers 
          IF WSHelper_CheckStaxSOAP11Header(reader) THEN
            IF NOT reader.isEmptyElement() THEN
               CALL WSHelper_FillSOAP11WSError("Client","No SOAP Header expected") 
               EXIT CASE 
            ELSE 
               CALL reader.nextTag()
            END IF 
          END IF 
          IF NOT WSHelper_ReadStaxSOAP11StartBody(reader) THEN
            EXIT CASE
          END IF
          # Retrieve SOAP Message taking soap:root attribute into account
          IF NOT WSHelper_RetrieveStaxSOAP11Message(reader) THEN
            EXIT CASE
          END IF
          #
          # STAX SOAP RESPONSE DESERIALIZE
          #
          CALL xml.Serializer.StaxToVariable(reader,ns1notificacionCuentaClabeResponse)
          IF NOT WSHelper_ReadStaxSOAP11EndBody(reader) THEN
            EXIT CASE
          END IF
          IF NOT WSHelper_ReadStaxSOAP11EndEnvelope(reader) THEN
            EXIT CASE
          END IF
          # End Streaming Response
          CALL notificacionCuentaClabeHTTPResp.endXmlResponse(reader)
          LET wsstatus = 0

        OTHERWISE
          CALL WSHelper_FillSOAP11WSError("Server","HTTP Error "||notificacionCuentaClabeHTTPResp.getStatusCode()||" ("||notificacionCuentaClabeHTTPResp.getStatusDescription()||")")

      END CASE
    CATCH
      LET wsstatus = status
      CALL WSHelper_FillSOAP11WSError("Server",SQLCA.SQLERRM)
    END TRY

  #
  # RESET VARIABLES
  #
  LET notificacionCuentaClabeHTTPReq = NULL
  LET notificacionCuentaClabeHTTPResp = NULL
  RETURN wsstatus

END FUNCTION


