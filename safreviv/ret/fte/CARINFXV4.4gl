#################################################################################
#Nombre del Programa => CARINFXV4                                               #
#Descripción         => Cambia el estado de la solicitud del trabajador a 100,  #
#                       desmarca la cuenta y restituir                          #
#Fecha creacion      => 06 de Octubre del 2015                                  #
#Por                 => Luis Felipe Prieto Cano                                 #
#Requerimiento       => CARINFXV-4                                              #
#################################################################################
DATABASE safre_viv 
GLOBALS
   DEFINE
      HOY                  DATE
   DEFINE
      enter                CHAR(1)
   DEFINE
      v_precio_fondo       LIKE glo_valor_fondo.precio_fondo
END GLOBALS

MAIN
    CALL init()         --Se inicializan variables
    CALL primer_paso()  --Restituye la cuenta
    CALL segundo_paso() --Cambia el estado de la solicitud de retiro a rechazada  Desmarca las cuentas
    CALL tercer_paso()  --Desmarca las cuentas
    DISPLAY "Se ejecuto el proceso correctamente."
END MAIN

FUNCTION init()
--------------
    LET HOY = TODAY
    
    SELECT precio_fondo
    INTO   v_precio_fondo
    FROM   glo_valor_fondo
    WHERE  fondo       = 11
    AND    f_valuacion = HOY
END FUNCTION

FUNCTION primer_paso()
----------------------
    --Restitución de solicitudes
    --En este caso no existen solicitudes a restituir
END FUNCTION

FUNCTION segundo_paso()
---------------------
    --Cambio de estado y codigo de rechazo para las solicitudes
      UPDATE ret_solicitud_generico
      SET    estado_solicitud = 100 ,
             cod_rechazo      = 54   
      WHERE  id_solicitud IN (7425247,7054067,7267156,7112522,7593049,6921101,7288062,5086023,7592785,5176677,7354274,6998038,
                              7278478,7566509,7354412,7115726,6981182,7153408,7389509,7392952,7146963,5080375,7197427,7575413,
                              7198668,5332184,7462043,7536221,7494532,7146991,5086917,7254957,7274722,7672901,7709915,7570766,
                              7432044,7058664,7657697,5336155,7212014,7429737,7579821,7579708,7709243,5320307,7398571,7150190,
                              7433865,7680025,7686623,7495216,7676676,7464782,7684425,7691659,7650272,7148439,7662386,5291199,
                              7678590,7222027,7566510,7721089,7427615,7658584,7399962,7151320,7277088,5078328,7494466,7407603,
                              7467929,5284280,7497732,7668876,7460185,7156986,7496608,7425260,7247576,7463310,7162199,7422980,
                              7434092,7443757,7431152,7434251,7214966,7413493,7498785,7580472,5177831,7421611,7267297,7234442,
                              7680466,7457564,7687620,5328053,7567565,7683947,5181312,7578292,7155423,7678965,7686218,7283464,
                              7672896,7574250,7683910,7388298,5080764,7564341,7502679,7147286,7292491,5090359,7641857,7494438,
                              7375716,7413615,7389344,7435959,7584815,7294728,7536662,7388122,7122102,7392549,5336726,7657720,
                              7656011,7154687,7205596,7354437,5199258,7466845,7464053,7289119,5083683,5195365,7247045,7390814,
                              7568486,7670917,5084029,7428688,7362966,7354512)
      
      UPDATE ret_amort_excedente
      SET    estado_solicitud = 100 ,
             cod_rechazo      = 54   
      WHERE  id_solicitud IN (7425247,7054067,7267156,7112522,7593049,6921101,7288062,5086023,7592785,5176677,7354274,6998038,
                              7278478,7566509,7354412,7115726,6981182,7153408,7389509,7392952,7146963,5080375,7197427,7575413,
                              7198668,5332184,7462043,7536221,7494532,7146991,5086917,7254957,7274722,7672901,7709915,7570766,
                              7432044,7058664,7657697,5336155,7212014,7429737,7579821,7579708,7709243,5320307,7398571,7150190,
                              7433865,7680025,7686623,7495216,7676676,7464782,7684425,7691659,7650272,7148439,7662386,5291199,
                              7678590,7222027,7566510,7721089,7427615,7658584,7399962,7151320,7277088,5078328,7494466,7407603,
                              7467929,5284280,7497732,7668876,7460185,7156986,7496608,7425260,7247576,7463310,7162199,7422980,
                              7434092,7443757,7431152,7434251,7214966,7413493,7498785,7580472,5177831,7421611,7267297,7234442,
                              7680466,7457564,7687620,5328053,7567565,7683947,5181312,7578292,7155423,7678965,7686218,7283464,
                              7672896,7574250,7683910,7388298,5080764,7564341,7502679,7147286,7292491,5090359,7641857,7494438,
                              7375716,7413615,7389344,7435959,7584815,7294728,7536662,7388122,7122102,7392549,5336726,7657720,
                              7656011,7154687,7205596,7354437,5199258,7466845,7464053,7289119,5083683,5195365,7247045,7390814,
                              7568486,7670917,5084029,7428688,7362966,7354512)
END FUNCTION

FUNCTION tercer_paso()
#---------------------
    --Desmarcar las cuentas
    DEFINE
        v_sql                CHAR(200)
    
    DEFINE
        v_resultado          SMALLINT 
        
    DEFINE
        reg_2                RECORD LIKE sfr_marca_activa.*
        
    DECLARE cur_2 CURSOR FOR
    SELECT *
    FROM   sfr_marca_activa
    WHERE  n_referencia IN (7425247,7054067,7267156,7112522,7593049,6921101,7288062,5086023,7592785,5176677,7354274,6998038,
                            7278478,7566509,7354412,7115726,6981182,7153408,7389509,7392952,7146963,5080375,7197427,7575413,
                            7198668,5332184,7462043,7536221,7494532,7146991,5086917,7254957,7274722,7672901,7709915,7570766,
                            7432044,7058664,7657697,5336155,7212014,7429737,7579821,7579708,7709243,5320307,7398571,7150190,
                            7433865,7680025,7686623,7495216,7676676,7464782,7684425,7691659,7650272,7148439,7662386,5291199,
                            7678590,7222027,7566510,7721089,7427615,7658584,7399962,7151320,7277088,5078328,7494466,7407603,
                            7467929,5284280,7497732,7668876,7460185,7156986,7496608,7425260,7247576,7463310,7162199,7422980,
                            7434092,7443757,7431152,7434251,7214966,7413493,7498785,7580472,5177831,7421611,7267297,7234442,
                            7680466,7457564,7687620,5328053,7567565,7683947,5181312,7578292,7155423,7678965,7686218,7283464,
                            7672896,7574250,7683910,7388298,5080764,7564341,7502679,7147286,7292491,5090359,7641857,7494438,
                            7375716,7413615,7389344,7435959,7584815,7294728,7536662,7388122,7122102,7392549,5336726,7657720,
                            7656011,7154687,7205596,7354437,5199258,7466845,7464053,7289119,5083683,5195365,7247045,7390814,
                            7568486,7670917,5084029,7428688,7362966,7354512)
    AND    marca         = 810

        
    FOREACH cur_2 INTO reg_2.*
        LET v_sql = "\nEXECUTE FUNCTION fn_desmarca_cuenta(","\n",reg_2.id_derechohabiente, ",",
                                                             "\n",reg_2.marca, ",",
                                                             "\n",reg_2.n_referencia,",",
                                                             "\n 0,",
                                                             "\n",reg_2.marca_causa,",",
                                                             "\n",'"SAFREVIV"',",",
                                                             "\n",reg_2.proceso_marca,")"
        PREPARE v_desmarca FROM v_sql
        EXECUTE v_desmarca INTO v_resultado                
    END FOREACH
END FUNCTION



