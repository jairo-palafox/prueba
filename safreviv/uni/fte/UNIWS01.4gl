#-------------------------------------------------------------------------------
# File: UNIWS01Service.4gl
# GENERATED BY fglwsdl 
#-------------------------------------------------------------------------------
# THIS FILE WAS GENERATED. DO NOT MODIFY.
#-------------------------------------------------------------------------------
#export FGLAPPSERVER=9121
#FORMA DE EJECUTAR http://172.16.16.204:9121/ConsultaUnificacionServices?wsdl
#http://10.90.8.132/Unificacion/ws/r/ConsultaUnificacionServices
#fastcgidispatch -s -f ConsultaUnificacionServices.xcf


IMPORT FGL WSHelper

IMPORT com
IMPORT xml
DATABASE safre_viv

GLOBALS "UNIWS01.inc"

#-------------------------------------------------------------------------------
# Service: ConsultaUnificacionServicesService
# Port:    ConsultaUnificacionServices
#-------------------------------------------------------------------------------
#
# FUNCTION CreateUNIWS01 Service
#   RETURNING soapstatus
MAIN
   DEFINE servicio     INTEGER
   DEFINE respuesta    INTEGER 
   
   CALL CreateConsultaUnificacionServices()
        RETURNING servicio --- funcion propia

   CALL com.WebServiceEngine.Start()

   DISPLAY("The server is listening.")

   WHILE TRUE
      #
      # Procesa cada request, regresa un entero que representa el estatus del request
      # el parametro -1 representa un valor infinito de espera
      #
      LET respuesta = com.WebServiceEngine.ProcessServices(-1)
      
      CASE respuesta
         WHEN 0
         WHEN -1
            DISPLAY "Timeout reached."
         WHEN -2
            DISPLAY "Disconnected from application server."
            EXIT PROGRAM   # The Application server has closed the connection
         WHEN -3
            DISPLAY "Client Connection lost."
         WHEN -4
            DISPLAY "Server interrupted with Ctrl-C."
         WHEN -10
            DISPLAY "Internal server error."
     END CASE

     IF int_flag <> 0 THEN
        LET int_flag = 0
        EXIT WHILE
     END IF     
   END WHILE
END MAIN
#
FUNCTION CreateConsultaUnificacionServices()
   DEFINE service      com.WebService
   DEFINE operation    com.WebOperation
   
   TRY
     # Create Web Service
     LET service = com.WebService.CreateWebService("ConsultaUnificacionServices",
                                                   "http://consultaUnificacion.efp.com") --- nombre de servicio como se publica
     
     #
     # Operation: consultarUnificacion
     #
   
     # Publish Operation : consultarUnificacion
     LET operation = com.WebOperation.CreateDOCStyle("consultarUnificacion" ,       --- nombre de la funcion que se publica
                                                     "consultarUnificacion",        --- nombre de funcion que se implementa
                                                     ns2unificacionRequest,         --- variable de parametros de entrada
                                                     ns2consultarUnificacionReturn) -- variable de salida
                                                     
     CALL service.publishOperation(operation,"")

     #
     # Register Service
     #
     CALL com.WebServiceEngine.RegisterService(service)
     RETURN 0
   
   CATCH
     RETURN STATUS
   END TRY

END FUNCTION
#
FUNCTION consultarUnificacion()

   DEFINE v_query_nss     STRING 
   DEFINE v_nss           CHAR(11)

   DEFINE v_id_derechohabiente decimal(10,0),
          v_credito            DECIMAL(10,0),
          v_estado_credito     CHAR(30),
          v_tipo_unificacion   CHAR(30),
          v_marca              SMALLINT,
          v_marca_activa       SMALLINT,
          v_count_marca        SMALLINT,
          v_count_marca_his    SMALLINT,
          v_marca_his          SMALLINT
 
--Consulta que busca el nss recibido 
   LET v_count_marca = 0    
   LET v_count_marca_his = 0

   LET v_query_nss=" SELECT nss, id_derechohabiente FROM afi_derechohabiente WHERE nss = ? "


   PREPARE prp_nss FROM v_query_nss
   
   EXECUTE prp_nss USING ns2unificacionRequest.nss
                    INTO v_nss,
                         v_id_derechohabiente
   
   INITIALIZE ns2consultarUnificacionReturn.* TO NULL
   
   IF v_nss IS NULL THEN --No existe NSS  
      
      LET ns2consultarUnificacionReturn.nss             = ns2unificacionRequest.nss            
      LET ns2consultarUnificacionReturn.marca_activa    = 0
      LET ns2consultarUnificacionReturn.marca_historica = 0
      LET ns2consultarUnificacionReturn.num_credito     = 0
      LET ns2consultarUnificacionReturn.estado_credito  = 0
      LET ns2consultarUnificacionReturn.codigoRespuesta ="1"
   ELSE --Existe NSS
   
      CALL fn_consulta_credito(v_id_derechohabiente)
          RETURNING v_credito,
                    v_estado_credito

      SELECT "DOR IMSS"
      INTO    v_tipo_unificacion
      FROM    uni_det_unificador
      WHERE   nss_unificador = ns2unificacionRequest.nss
      AND     estado_familia = 1
      UNION 
      SELECT "DOR Infonavit"
      INTO    v_tipo_unificacion
      FROM    uni_inf_unificador
      WHERE   nss = ns2unificacionRequest.nss
      AND     estado_familia = 1
      UNION
      SELECT "ADO IMSS"
      INTO    v_tipo_unificacion
      FROM    uni_det_unificado c, uni_det_unificador d
      WHERE   c.nsscta1 = ns2unificacionRequest.nss
      AND     d.id_unificador = c.id_unificador
      AND     d.estado_familia = 1
      UNION 
      SELECT "ADO Infonavit"
      INTO    v_tipo_unificacion
      FROM    uni_inf_unificado e, uni_inf_unificador f
      WHERE   e.nss     = ns2unificacionRequest.nss
      AND     f.id_inf_unificador = e.id_unificador
      AND     f.estado_familia = 1
      GROUP BY 1

      IF v_tipo_unificacion IS NULL THEN --Unificacion rechazada
         LET ns2consultarUnificacionReturn.nss             = ns2unificacionRequest.nss            
         LET ns2consultarUnificacionReturn.marca_activa    = 0
         LET ns2consultarUnificacionReturn.marca_historica = 0
         LET ns2consultarUnificacionReturn.num_credito     = 0
         LET ns2consultarUnificacionReturn.estado_credito  = 0
         LET ns2consultarUnificacionReturn.codigoRespuesta ="2"
      ELSE
         IF ns2unificacionRequest.tipo_consulta = 1 THEN
            IF v_tipo_unificacion = "DOR IMSS" THEN
               LET v_marca = 501
            
               SELECT COUNT(*)
               INTO   v_count_marca
               FROM   sfr_marca_activa
               WHERE  id_derechohabiente = v_id_derechohabiente
               AND    marca = v_marca
            
               IF v_count_marca > 0 THEN
                  LET v_marca_activa = 1
               ELSE
                  LET v_marca_activa = 2
               END IF
            
               IF v_marca_activa = 2 THEN
                  SELECT COUNT(*)
                  INTO   v_count_marca_his
                  FROM   sfr_marca_historica
                  WHERE  id_derechohabiente = v_id_derechohabiente
                  AND    marca = v_marca
                  AND    estado_marca  = 0
            
                  IF v_count_marca_his > 0 THEN
                     LET v_marca_his = 3
                  ELSE
                     LET v_marca_his = 4
                  END IF
               END IF 
            END IF 
            
            IF v_tipo_unificacion = "DOR Infonavit" THEN
               
               LET v_marca = 503
               
               SELECT COUNT(*)
               INTO   v_count_marca
               FROM   sfr_marca_activa
               WHERE  id_derechohabiente = v_id_derechohabiente
               AND    marca = v_marca
            
               IF v_count_marca > 0 THEN
                  LET v_marca_activa = 1
               ELSE
                  LET v_marca_activa = 2
               END IF
            
               IF v_marca_activa = 2 THEN
                  SELECT COUNT(*)
                  INTO   v_count_marca_his
                  FROM   sfr_marca_historica
                  WHERE  id_derechohabiente = v_id_derechohabiente
                  AND    marca = v_marca
                  AND    estado_marca  = 0
            
                  IF v_count_marca_his > 0 THEN
                     LET v_marca_his = 3
                  ELSE
                     LET v_marca_his = 4
                  END IF
               END IF 
            END IF 
            
            IF v_tipo_unificacion = "ADO IMSS" THEN
               LET v_marca = 502
            
               SELECT COUNT(*)
               INTO   v_count_marca
               FROM   sfr_marca_activa
               WHERE  id_derechohabiente = v_id_derechohabiente
               AND    marca = v_marca
            
               IF v_count_marca > 0 THEN
                  LET v_marca_activa = 1
               ELSE
                  LET v_marca_activa = 2
               END IF
            
               IF v_marca_activa = 2 THEN
                  SELECT COUNT(*)
                  INTO   v_count_marca_his
                  FROM   sfr_marca_historica
                  WHERE  id_derechohabiente = v_id_derechohabiente
                  AND    marca = v_marca
                  AND    estado_marca  = 0
            
                  IF v_count_marca_his > 0 THEN
                     LET v_marca_his = 3
                  ELSE
                     LET v_marca_his = 4
                  END IF
               END IF 
            END IF 
            
            IF v_tipo_unificacion = "ADO Infonavit" THEN
               
               LET v_marca = 504
               
               SELECT COUNT(*)
               INTO   v_count_marca
               FROM   sfr_marca_activa
               WHERE  id_derechohabiente = v_id_derechohabiente
               AND    marca = v_marca
            
               IF v_count_marca > 0 THEN
                  LET v_marca_activa = 1
               ELSE
                  LET v_marca_activa = 2
               END IF
            
               IF v_marca_activa = 2 THEN
                  SELECT COUNT(*)
                  INTO   v_count_marca_his
                  FROM   sfr_marca_historica
                  WHERE  id_derechohabiente = v_id_derechohabiente
                  AND    marca = v_marca
                  AND    estado_marca  = 0
            
                  IF v_count_marca_his > 0 THEN
                     LET v_marca_his = 3
                  ELSE
                     LET v_marca_his = 4
                  END IF
               END IF 
            END IF
         
            LET ns2consultarUnificacionReturn.nss             = ns2unificacionRequest.nss            
            LET ns2consultarUnificacionReturn.marca_activa    = v_marca_activa 
            LET ns2consultarUnificacionReturn.marca_historica = v_marca_his
            LET ns2consultarUnificacionReturn.num_credito     = v_credito
            LET ns2consultarUnificacionReturn.estado_credito  = v_estado_credito
            LET ns2consultarUnificacionReturn.codigoRespuesta = "0"
         END IF
         
         IF ns2unificacionRequest.tipo_consulta = 3 THEN
            IF v_tipo_unificacion = "DOR IMSS" THEN
               LET v_marca = 501
         
               SELECT COUNT(*)
               INTO   v_count_marca_his
               FROM   sfr_marca_historica
               WHERE  id_derechohabiente = v_id_derechohabiente
               AND    marca = v_marca
               AND    estado_marca  = 0
            
               IF v_count_marca_his > 0 THEN
                  LET v_marca_his = 1
               ELSE
                  LET v_marca_his = 2
               END IF           
            END IF 
            
            IF v_tipo_unificacion = "DOR Infonavit" THEN
               
               LET v_marca = 503
               
               SELECT COUNT(*)
               INTO   v_count_marca_his
               FROM   sfr_marca_historica
               WHERE  id_derechohabiente = v_id_derechohabiente
               AND    marca = v_marca
               AND    estado_marca  = 0
            
               IF v_count_marca_his > 0 THEN
                  LET v_marca_his = 1
               ELSE
                  LET v_marca_his = 2
               END IF
            END IF 
            
            IF v_tipo_unificacion = "ADO IMSS" THEN
               LET v_marca = 502
            
               SELECT COUNT(*)
               INTO   v_count_marca_his
               FROM   sfr_marca_historica
               WHERE  id_derechohabiente = v_id_derechohabiente
               AND    marca = v_marca
               AND    estado_marca  = 0
            
               IF v_count_marca_his > 0 THEN
                  LET v_marca_his = 1
               ELSE
                  LET v_marca_his = 2
               END IF
            END IF 
            
            IF v_tipo_unificacion = "ADO Infonavit" THEN
               
               LET v_marca = 504
               
               SELECT COUNT(*)
               INTO   v_count_marca_his
               FROM   sfr_marca_historica
               WHERE  id_derechohabiente = v_id_derechohabiente
               AND    marca = v_marca
               AND    estado_marca  = 0
            
               IF v_count_marca_his > 0 THEN
                  LET v_marca_his = 1
               ELSE
                  LET v_marca_his = 2
               END IF
            END IF
         
            LET ns2consultarUnificacionReturn.nss             = ns2unificacionRequest.nss            
            LET ns2consultarUnificacionReturn.marca_activa    = 0 
            LET ns2consultarUnificacionReturn.marca_historica = v_marca_his
            LET ns2consultarUnificacionReturn.num_credito     = v_credito
            LET ns2consultarUnificacionReturn.estado_credito  = v_estado_credito
            LET ns2consultarUnificacionReturn.codigoRespuesta = "0"
         END IF
      END IF
   END IF 
END FUNCTION 
#
FUNCTION fn_consulta_credito(p_id_derechohabiente)

   DEFINE v_QryTxt             STRING,
          p_id_derechohabiente DECIMAL(9,0),
          v_tipo_consulta_cre  SMALLINT

   DEFINE v_resultado           SMALLINT,
          v_tpo_originacion     SMALLINT,
          v_tpo_credito         SMALLINT,
          v_num_credito         DECIMAL(10,0),
          v_f_otorga            DATE,
          v_f_liquida           DATE,
          v_estado_credito      CHAR(30)

   LET v_tipo_consulta_cre = 1
   
   LET v_QryTxt = "EXECUTE FUNCTION fn_credito_vivienda(?,?)"
   
   PREPARE prp_cred_viv_ado FROM v_QryTxt CLIPPED
   EXECUTE prp_cred_viv_ado USING p_id_derechohabiente,  
                                  v_tipo_consulta_cre
                            INTO  v_resultado,
                                  v_tpo_originacion,
                                  v_tpo_credito,
                                  v_num_credito,
                                  v_f_otorga, 
                                  v_f_liquida;

    CASE v_resultado
       WHEN 0 LET v_estado_credito = "CREDITO VIGENTE"
       WHEN 1 LET v_estado_credito = "NO TIENE CREDITO"
       WHEN 2 LET v_estado_credito = "CREDITO LIQUIDADO"
    END CASE

    IF v_resultado = 1 THEN
       LET v_num_credito = 0
    END IF
    
   RETURN v_num_credito, v_estado_credito
END FUNCTION